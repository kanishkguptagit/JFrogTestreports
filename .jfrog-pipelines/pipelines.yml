resources:
  - name: myRepoResource
    type: GitRepo
    configuration:
      gitProvider: int_github
      path: kanishkguptagit/JFrogTestreports
      branches:
        include: master

  - name: myPropertyBag
    type: PropertyBag
    configuration:
      STEP_ID: value

pipelines:
  - name: sanity_TestReports
    steps:
      - name: GenerateReports
        type: Bash
        configuration:
          inputResources:
            - name: myRepoResource
          outputResources:
            - name: myPropertyBag
        execution:
          onExecute:
            - echo "${step_id}"
            - save_tests "$res_myRepoResource_resourcePath/tests/junit/test_results_example_1.xml"
            - write_output myPropertyBag "STEP_ID=${step_id}"
            

      - name: verifyReports
        type: Bash
        configuration:
          integrations:
            - name: PipelinesToken
          inputResources:
            - name: myPropertyBag
          inputSteps:
            - name: GenerateReports
        execution:
          onExecute:
            - echo "${res_myPropertyBag_STEP_ID}"
            - echo "${int_PipelinesToken_token}" | jq --raw-output .value
            - REQUIRED_TOKEN=$(echo ${int_PipelinesToken_token} | jq --raw-output .value)
            - echo "${REQUIRED_TOKEN}"
            - |
              curl -o testReportOutput_${res_myPropertyBag_STEP_ID}.tar.gz --location 'https://master.jfrog-pipelines.com/pipelines/api/v1/steps/${res_myPropertyBag_STEP_ID}/stepTestReports' --header 'Authorization: Bearer ${REQUIRED_TOKEN}'
            - ls -la
            - file testReportOutput_${res_myPropertyBag_STEP_ID}.tar.gz
            - cat testReportOutput_${res_myPropertyBag_STEP_ID}.tar.gz
            - tar -xzvf testReportOutput_${res_myPropertyBag_STEP_ID}.tar.gz
            - cat tests/testReports/testReport.json

